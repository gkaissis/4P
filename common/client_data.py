import abc
import argparse
import functools
import logging
import os
import pathlib
import shutil

import numpy as np
import pandas as pd


def parse_args():
  parser = argparse.ArgumentParser(description="Client allocation")
  parser.add_argument('-c', '--train-clients', default=5, type=int)
  parser.add_argument('-t', '--test-clients', default=5, type=int)
  parser.add_argument('-s', '--seed', default=42, type=int)
  parser.add_argument('-d', '--data-root', default='./data')
  parser.add_argument('--train-clients-subdir', default='train_clients')
  parser.add_argument('--test-clients-subdir', default='test_clients')
  return parser.parse_args()


def split_dataframe(df, split):
  assert split in ['train', 'test']
  imgs = df[df['Dataset_type'] == split.upper()].drop('Dataset_type', 1)
  return imgs


def make_client_ids(num_clients):
  return ["client-{:02d}".format(i) for i in range(num_clients)]


def split_dataframe_for_clients(df, client_ids):
  splits = np.array_split(
      df.loc[np.random.permutation(df.index)], len(client_ids))
  return dict(zip(client_ids, splits))


def allocate_samples_on_disk(
    client_samples,
    data_root: pathlib.Path,
    split_subdir: str,
    clients_subdir: str,
):
  split_root = data_root / split_subdir  # e.g. 4P/data/train
  clients_root = data_root / clients_subdir  # e.g. 4P/data/train_clients
  
  for client_id, sample in client_samples.items():
    # e.g. 4P/data/train_clients/client-03/
    client_path = clients_root / client_id

    for label in ["0", "1", "2"]:
      (client_path / label).mkdir(parents=True, exist_ok=True)

    for imname, label in zip(sample.X_ray_image_name, sample.Numeric_Label):
      shutil.copy(split_root / imname, client_path / str(label) / imname)


def main(args):
  np.random.seed(args.seed)
  data_root = pathlib.Path(args.data_root)

  df = pd.read_csv(data_root.joinpath("Labels.csv"))

  train_df = split_dataframe(df, 'train')
  test_df = split_dataframe(df, 'test')

  train_ids = make_client_ids(args.train_clients)
  test_ids = make_client_ids(args.test_clients)

  train_splits = split_dataframe_for_clients(train_df, train_ids)
  test_splits = split_dataframe_for_clients(test_df, test_ids)

  logging.info("Allocating client images on disk...")
  allocate_samples_on_disk(
      train_splits, data_root, 'train', args.train_clients_subdir)
  allocate_samples_on_disk(
      test_splits, data_root, 'test', args.test_clients_subdir)
  
  logging.info("Finished.")


if __name__ == '__main__':
  logging.basicConfig(level=logging.INFO)
  args = parse_args()
  main(args)
  


